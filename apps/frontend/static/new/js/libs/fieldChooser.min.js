(function(e){e.fn.fieldChooser=function(t,n,r){function i(e){var t=e.offset();return{left:t.left,right:t.left+e.width(),top:t.top,bottom:t.top+e.height()}}function s(e,t){return{left:t.left,right:e.right+t.left-e.left,top:t.top,bottom:e.bottom+t.top-e.top}}function o(e,t,n){var r=i(e);var o=i(t);o=s(o,n);var u=true;if(o.right<r.left){u=false}else if(o.left>r.right){u=false}else if(o.bottom<r.top){u=false}else if(o.top>r.bottom){u=false}return u}function f(e,t){if(a){if(a==t){}else{var n=u.getSourceList();if(t==u.getSourceList()){n=u.getDestinationList()}n.clearSelection(true)}}a=t}if(this.getOptions){return this}var u=this;var a=null;var l=function(t,n){var r=e(t);r.addClass("fc-field-list");r.attr("tabIndex",n);var i=-1;var s=-1;var o=function(t,r){r.addClass("fc-field");r.attr("tabIndex",n);r.off("click.field");r.on("click.field",function(n){n.stopPropagation();n.preventDefault();var r=e(this);if(n.ctrlKey||n.metaKey){u.getFieldList(r).toggleFieldSelection(r)}else if(n.shiftKey){u.getFieldList(r).selectTo(r)}else{u.getFieldList(r).selectField(r)}v=t})};o(r,r.children());r.selectAt=function(e,t){this.clearSelection(true);var n=r.getFields();if(e>=n.length){e=n.length-1}var s=null;if(e>=0){s=n.eq(e)}if(s){s.addClass("fc-selected");i=e;r.scrollToField(s,t)}else{i=-1}r.trigger("selectionChanged",[r])};r.extendSelection=function(e){var t=this.getSelectedIndex();var n=this.getExtendedSelectionIndex();var o=n;var u=true;if(e){if(o<0){o=r.getFields().length;i=o-1}if(n>t){u=false}else{o--}}else{if(o<0){i=0}if(n<t){u=false}else{o++}}var a=r.getFields();if(o<0||o>=a.length){}else{var f=a.eq(o);if(u){f.addClass("fc-selected")}else{f.removeClass("fc-selected");if(e){o--}else{o++}if(o>=0&&o<a.length){f=a.eq(o)}}r.scrollToField(f,e);r.trigger("selectionChanged",[r]);s=o}};r.selectField=function(e){this.clearSelection(true);e.addClass("fc-selected");i=e.index();r.trigger("selectionChanged",[r])};r.toggleFieldSelection=function(e){e.toggleClass("fc-selected");if(e.hasClass("fc-selected")){i=e.index();s=-1}else{if(i==e.index()){i=r.children(".fc-selected").first().index()}}r.trigger("selectionChanged",[r])};r.selectTo=function(e){var t=e;if(typeof e=="object"){t=e.index()}if(i==-1){i=0}var n=r.children();if(t>i){for(var o=i;o<n.length;o++){if(o<=t){n.eq(o).addClass("fc-selected")}else{n.eq(o).removeClass("fc-selected")}}}else{for(var o=i;o>=0;o--){if(o>=t){n.eq(o).addClass("fc-selected")}else{n.eq(o).removeClass("fc_selected")}}}s=t;r.trigger("selectionChanged",[r])};r.getSelectedIndex=function(){return i};r.getExtendedSelectionIndex=function(){var e=s;if(e<0){e=i}return e};r.getSelection=function(){return this.children(".fc-selected")};r.clearSelection=function(e){i=-1;s=-1;this.children().removeClass("fc-selected");if(e){}else{r.trigger("selectionChanged",[r])}};r.add=function(e){o(r,e);e.appendTo(r);return r};r.getFields=function(){return r.children()};r.scrollToField=function(e,t){var n=r.height();var i=r.scrollTop();var s=i+n;var o=e.height();var u=e.offset().top;var a=u+o;if(t){if(u<0){r.scrollTop(i+u)}else if(a>n){r.scrollTop(n+o)}}else{if(u<0){r.scrollTop(i+u-o)}else if(a>n){r.scrollTop(i+(a-n))}}};r.sortable({connectWith:".fc-field-list",cursor:"move",opacity:.75,helper:function(t,n){if(n.hasClass("fc-selected")){}else{r.selectField(n)}var i=r.getSelection().clone();n.data("selection",i);n.siblings(".fc-selected").remove();var s=e("<div/>").append(i);return s}});return r};var c=e.extend({},e.fn.fieldChooser.defaults,r);var h=parseInt(this.attr("tabIndex"));if(isNaN(h)){h=0}this.removeAttr("tabIndex");var p=(new l(t,h)).addClass("fc-source-fields");var d=(new l(n,h)).addClass("fc-destination-fields");var v=null;this.getOptions=function(){return c};this.getSourceList=function(){return p};this.getDestinationList=function(){return d};this.getFieldList=function(e){var t=d;if(e.parent().hasClass("fc-source-fields")){t=p}return t};this.destroy=function(){this.getOptions=null;p.sortable("destroy");d.sortable("destroy")};d.on("sortstop",function(e,t){var n=t.item.data("selection");if(o(p,t.item,t.offset)){v=p;p.add(n);d.clearSelection();p.trigger("selectionChanged",[p]);u.trigger("listChanged",[n,p]);t.item.after(n).remove()}else if(o(d,t.item,t.offset)){t.item.after(n).remove()}else{d.getSelection().remove();p.add(n);p.scrollToField(n,false);d.clearSelection();p.trigger("selectionChanged",[p]);v=p;u.trigger("listChanged",[n,p])}});p.on("sortstop",function(e,t){var n=t.item.data("selection");if(o(d,t.item,t.offset)){v=d;d.add(n);p.clearSelection();d.trigger("selectionChanged",[d]);u.trigger("listChanged",[n,d])}else if(o(p,t.item,t.offset)){}else{p.sortable("cancel")}t.item.after(n).remove()});d.on("selectionChanged",f);p.on("selectionChanged",f);d.on("focusin",function(){v=d});d.on("focusout",function(){if(v==d){v=null}});p.on("focusin",function(){v=p});p.on("focusout",function(){if(v==p){v=null}});e(document).keydown(function(){if(v){if(event.which==38){if(event.shiftKey){v.extendSelection(true)}else{var e=v.getSelectedIndex();var t=e-1;if(t<0){t=0}v.selectAt(t,true)}}else if(event.which==40){if(event.shiftKey){v.extendSelection(false)}else{var e=v.getSelectedIndex();var t=e+1;if(e<0){t=v.getFields().length-1}v.selectAt(t,false)}}else if(event.which==27){v.selectAt(-1)}}});return this};e.fn.fieldChooser.defaults={}})(jQuery)